name: Reusable Aspect Test

on:
  workflow_call:
    inputs:
      test_node_addr:
        required: true
        type: string
      test_script:
        required: true
        type: string
      key_attack_accounts:
        required: true
        type: string
      key_privateKey:
        required: true
        type: string
      key_aspect_accounts:
        required: true
        type: string

jobs:
  test-job:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Aspect Test
      run: |
        mkdir -p test_scripts
        cat > test_scripts/init_env.sh <<EOF
          source ~/.nvm/nvm.sh
          set -ex
          cd /aspect-tooling/packages/testcases
          sed -i "s|\"node\": \".*\"|\"node\": \"${{ inputs.test_node_addr }}\"|g" project.config.json && cat project.config.json
          # key1
          echo '${{ inputs.key_attack_accounts }}' > attack_accounts.txt
          # key2
          echo '${{ inputs.key_privateKey }}' > privateKey.txt
          # key3
          echo '${{ inputs.key_aspect_accounts }}' > aspect_accounts.txt
          
          cd tests
          node ${{ inputs.test_script }}

        EOF
        chmod +x test_scripts/init_env.sh
        docker run --name testenv -v $(pwd)/test_scripts:/test_scripts -i simonalphafang/aspect-tooling:0.0.3 /bin/bash -c /test_scripts/init_env.sh